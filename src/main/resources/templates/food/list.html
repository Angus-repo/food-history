<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食物列表 - 食物歷史</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0369a1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/recommendations.css" rel="stylesheet">
</head>
<body>
    <!-- 離線橫幅 -->
    <div id="offlineBanner" class="offline-banner">
        <i class="bi bi-wifi-off"></i>
        您目前處於離線模式，顯示的是快取資料
    </div>
    <div class="container fade-in">
        <!-- 頁面標題區域 -->
        <header class="page-header">
            <!-- 第一行：標題與登出 -->
            <div class="header-row-1">
                <h1 class="page-title">
                    <a href="/foods" class="title-link" style="color: inherit; display: flex; align-items: center; gap: var(--space-2);">
                        <i class="bi bi-journal-bookmark"></i>
                        我的食物歷史
                    </a>
                </h1>
                <form method="post" action="/logout" class="logout-form">
                    <button type="submit" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-box-arrow-right"></i>
                        登出
                    </button>
                </form>
            </div>
            <!-- 第二行：狀態指示器 -->
            <div class="header-row-2">
                <!-- 連線狀態指示器 -->
                <div id="connectionIndicator" class="connection-indicator online">
                    <i class="bi bi-wifi"></i> 線上
                </div>
                <!-- 快取狀態 -->
                <div id="cacheStatus" class="cache-status">
                    <i class="bi bi-database"></i> 未快取
                </div>
                <!-- 更新快取按鈕 -->
                <button type="button" id="refreshCacheBtn" class="btn btn-outline-primary btn-sm refresh-btn" title="更新離線快取">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <!-- 第三行：新增按鈕 -->
            <div class="header-row-3">
                <a href="/foods/new" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-lg"></i>
                    新增食物
                </a>
            </div>
        </header>

        <!-- 提示訊息 -->
        <div th:if="${success}" class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <span th:text="${success}"></span>
        </div>
        
        <div th:if="${error}" class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <span th:text="${error}"></span>
        </div>

        <!-- 搜尋區域 -->
        <div class="search-container">
            <form method="get" action="/foods" class="flex gap-3">
                <div class="flex-1" style="position: relative;">
                    <i class="search-icon bi bi-search"></i>
                    <input type="text" 
                           name="keyword" 
                           th:value="${keyword}"
                           class="search-input" 
                           placeholder="搜尋食物名稱或備註..."
                           autocomplete="off">
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i>
                    搜尋
                </button>
                <a th:if="${keyword != null and keyword != ''}" 
                   href="/foods" 
                   class="btn btn-secondary">
                    <i class="bi bi-x-lg"></i>
                    清除
                </a>
            </form>
            
            <!-- 搜尋推薦 -->
            <div th:if="${keyword == null or keyword == ''}" class="search-recommendations">
                
                <!-- 近期搜尋 -->
                <div th:if="${!#lists.isEmpty(recentSearches)}" class="recommendations-section">
                    <div class="section-header">
                        <h4 class="recommendation-title">
                            <i class="bi bi-clock-history"></i>
                            近期搜尋
                        </h4>
                        <button type="button" class="simple-view-all-btn" onclick="showRecentSearches()">
                            完整搜尋記錄
                        </button>
                    </div>
                    <div class="recommendations-container">
                        <button th:each="search : ${recentSearches}" 
                                type="button" 
                                class="recommendation-tag recent-search"
                                th:data-keyword="${search}"
                                onclick="searchFood(this.dataset.keyword)">
                            <i class="bi bi-search"></i>
                            <span th:text="${search}">搜尋詞</span>
                        </button>
                    </div>
                </div>
                
                <!-- 最愛推薦 -->
                <div th:if="${!#lists.isEmpty(favoriteRecommendations)}" class="recommendations-section">
                    <div class="section-header">
                        <h4 class="recommendation-title">
                            <i class="bi bi-star-fill text-warning-500"></i>
                            我的最愛
                        </h4>
                        <button type="button" class="simple-view-all-btn" onclick="showAllFavorites()">
                            完整我的最愛
                        </button>
                    </div>
                    <div class="recommendations-container">
                        <button th:each="food : ${favoriteRecommendations}" 
                                type="button" 
                                class="recommendation-tag favorite-item"
                                th:data-keyword="${food.name}"
                                onclick="searchFood(this.dataset.keyword)">
                            <i class="bi bi-star-fill"></i>
                            <span th:text="${food.name}">食物名稱</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 統計資訊 -->
        <div class="card" style="margin-bottom: var(--space-8);">
            <div class="card-body">
                <div class="stats-container">
                    <div class="stats-main">
                        <div class="stats-item">
                            <i class="bi bi-collection text-primary-500" style="font-size: var(--font-size-xl);"></i>
                            <span class="font-medium">總共</span>
                            <span class="font-bold text-primary-600" th:text="${totalElements}">0</span>
                            <span>項</span>
                        </div>
                        <div class="stats-item">
                            <i class="bi bi-files text-secondary-500"></i>
                            <span class="text-secondary-600">
                                <span th:text="${currentPage + 1}">1</span>/<span th:text="${totalPages}">1</span>
                            </span>
                            <span>頁</span>
                        </div>
                    </div>
                    <div th:if="${keyword != null and keyword != ''}" class="stats-filter">
                        <i class="bi bi-funnel text-secondary-500"></i>
                        <span class="text-secondary-600">搜尋</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 離線搜尋結果容器 (預設隱藏) -->
        <div id="offlineSearchResults" style="display: none;"></div>

        <!-- 原始內容容器 -->
        <div id="originalContent">
            <!-- 食物卡片網格 -->
            <div th:if="${#lists.isEmpty(foods)}" class="text-center" style="padding: var(--space-16) 0;">
                <i class="bi bi-inbox" style="font-size: 4rem; color: var(--secondary-400); margin-bottom: var(--space-4);"></i>
                <h3 style="color: var(--secondary-600); margin-bottom: var(--space-2);">
                    <span th:if="${keyword != null and keyword != ''}">找不到相關食物</span>
                    <span th:unless="${keyword != null and keyword != ''}">還沒有任何食物記錄</span>
                </h3>
                <p style="color: var(--secondary-500); margin-bottom: var(--space-6);">
                    <span th:if="${keyword != null and keyword != ''}">試試其他關鍵字或</span>
                    開始記錄您的第一個食物吧！
                </p>
                <a href="/foods/new" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-lg"></i>
                    新增第一個食物
            </a>
        </div>

        <div th:unless="${#lists.isEmpty(foods)}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div th:each="food, iterStat : ${foods}" 
                 th:id="'food-' + ${food.id}"
                 class="food-card card slide-in clickable-card enhanced-card"
                 th:style="'animation-delay: ' + ${iterStat.index * 0.1} + 's'"
                 th:data-food-id="${food.id}"
                 th:data-keyword="${keyword}"
                 th:data-page="${currentPage}"
                 onclick="navigateToEditFromCard(this)">
                <!-- 最愛標記 -->
                <div th:if="${food.isFavorite}" class="favorite-badge">
                    <i class="bi bi-star-fill"></i>
                </div>

                <!-- 食物名稱（移到最上方） -->
                <div class="food-card-title-wrapper" style="padding: var(--space-5) var(--space-5) 0 var(--space-5); position: relative; min-height: 3.5em;">
                    <!-- 名稱獨立一層 -->
                    <h3 class="food-card-title" style="margin-bottom: 0;">
                        <span class="food-name" th:text="${food.name}">食物名稱</span>
                    </h3>
                </div>

                <!-- 食物圖片（移到名稱下方） -->
                <div class="relative food-card-image-wrapper" style="height: 220px; overflow: hidden;">
                    <!-- 份數右上角浮動在圖片上 -->
                    <div class="food-portion-badge food-portion-badge-image" style="position: absolute; top: 0.5rem; right: 0.5rem;">
                        <span th:if="${food.quantity != null and food.quantity > 0 and food.unit != null and food.unit != ''}"
                              class="food-unit">
                            (<span th:text="${food.quantity % 1 == 0 ? T(java.lang.Math).round(food.quantity) : food.quantity}"></span><span th:text="${food.unit}"></span>)
                        </span>
                        <span th:if="${(food.quantity == null or food.quantity <= 0) and food.unit != null and food.unit != ''}"
                              class="food-unit">
                            (<span th:text="${food.unit}"></span>)
                        </span>
                    </div>
                    <img th:if="${food.imagePath != null}" 
                         th:src="@{'/foods/images/' + ${food.imagePath}}"
                         class="food-card-image enhanced-image"
                         th:alt="${food.name}">
                    <div th:unless="${food.imagePath != null}" 
                         class="food-card-image flex items-center justify-center enhanced-placeholder"
                         style="background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);">
                        <i class="bi bi-image" style="font-size: 3.5rem; color: #9ca3af;"></i>
                    </div>
                    <!-- 編輯提示 -->
                    <div class="edit-overlay enhanced-overlay">
                        <div class="edit-hint">
                            <i class="bi bi-pencil-square"></i>
                            <span>點擊編輯</span>
                        </div>
                    </div>
                </div>

                <!-- 食物資訊 -->
                <div class="food-card-content enhanced-content">
                    <!-- 碳水化合物資訊 -->
                    <div class="food-card-carb-info">
                        <!-- 如果有比例，顯示比例資訊 -->
                        <div th:if="${food.coefficient != null and food.coefficient != 0.0}" class="carb-info-item">
                            <div class="carb-info-label">
                                <i class="bi bi-percent text-primary-500"></i>
                                <span>系數</span>
                            </div>
                            <div class="carb-info-value">
                                <span class="coefficient-green" th:text="${food.coefficient}"></span>
                                <small>比例值</small>
                            </div>
                        </div>
                        <!-- 如果有具體克數，顯示克數資訊 -->
                        <div th:if="${food.carbGrams != null and food.carbGrams != 0.0}" class="carb-info-item">
                            <div class="carb-info-label">
                                <i class="bi bi-graph-up text-success-500"></i>
                                <span>碳水化合物(克)</span>
                            </div>
                            <div class="carb-info-value">
                                <span class="carb-orange" th:text="${food.carbGrams % 1 == 0 ? #numbers.formatInteger(food.carbGrams, 0) : #numbers.formatDecimal(food.carbGrams, 1, 'DEFAULT', 1, 'DEFAULT')}"></span>
                                <small>此份食物</small>
                            </div>
                        </div>
                        <!-- 如果兩者都沒有 -->
                        <div th:if="${food.coefficient == null and food.carbGrams == null}" class="carb-info-item">
                            <div class="carb-info-empty">
                                <i class="bi bi-dash-circle text-secondary-400"></i>
                                <span class="text-secondary-500">未設定碳水資訊</span>
                            </div>
                        </div>
                    </div>
                    <!-- 備註資訊 -->
                    <div th:if="${food.notes != null and food.notes != ''}" class="food-card-notes-section">
                        <div class="notes-label">
                            <i class="bi bi-chat-text text-secondary-500"></i>
                            <span>備註</span>
                        </div>
                        <p class="food-card-notes" th:text="${food.notes}">食物備註...</p>
                    </div>
                    <!-- 操作提示 -->
                    <div class="food-card-actions">
                        <div class="edit-prompt">
                            <i class="bi bi-hand-index text-primary-500"></i>
                            <span class="text-primary-600">點擊卡片即可編輯</span>
                        </div>
                        <button type="button" 
                                class="btn btn-outline-danger btn-sm"
                                th:onclick="'event.stopPropagation(); deleteFood(' + ${food.id} + ')'"
                                title="刪除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- 關閉 #originalContent -->

        <!-- 分頁導航 -->
        <div th:if="${totalPages > 1}" class="pagination-container">
            <div class="pagination">
                <!-- 上一頁 -->
                <a th:if="${hasPrevious}" 
                   th:href="@{/foods(page=${currentPage - 1}, size=12, keyword=${keyword})}"
                   class="pagination-btn pagination-prev">
                    <i class="bi bi-chevron-left"></i>
                    上一頁
                </a>
                
                <!-- 頁碼 -->
                <div class="pagination-numbers">
                    <!-- 第一頁 -->
                    <a th:if="${currentPage > 2}" 
                       th:href="@{/foods(page=0, size=12, keyword=${keyword})}"
                       class="pagination-number">1</a>
                    
                    <!-- 省略號 -->
                    <span th:if="${currentPage > 3}" class="pagination-ellipsis">...</span>
                    
                    <!-- 前一頁 -->
                    <a th:if="${currentPage > 0}" 
                       th:href="@{/foods(page=${currentPage - 1}, size=12, keyword=${keyword})}"
                       class="pagination-number" 
                       th:text="${currentPage}">1</a>
                    
                    <!-- 當前頁 -->
                    <span class="pagination-number pagination-current" th:text="${currentPage + 1}">1</span>
                    
                    <!-- 下一頁 -->
                    <a th:if="${currentPage < totalPages - 1}" 
                       th:href="@{/foods(page=${currentPage + 1}, size=12, keyword=${keyword})}"
                       class="pagination-number" 
                       th:text="${currentPage + 2}">3</a>
                    
                    <!-- 省略號 -->
                    <span th:if="${currentPage < totalPages - 4}" class="pagination-ellipsis">...</span>
                    
                    <!-- 最後一頁 -->
                    <a th:if="${currentPage < totalPages - 3}" 
                       th:href="@{/foods(page=${totalPages - 1}, size=12, keyword=${keyword})}"
                       class="pagination-number" 
                       th:text="${totalPages}">5</a>
                </div>
                
                <!-- 下一頁 -->
                <a th:if="${hasNext}" 
                   th:href="@{/foods(page=${currentPage + 1}, size=12, keyword=${keyword})}"
                   class="pagination-btn pagination-next">
                    下一頁
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>

        <!-- 底部間距 -->
        <div style="height: var(--space-16);"></div>
    </div>

    <!-- 刪除確認對話框 -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>確認刪除</h3>
            <p>您確定要刪除這個食物記錄嗎？此操作無法復原。</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">刪除</button>
            </div>
        </div>
    </div>

    <!-- 近期搜尋完整清單模態框 -->
    <div id="recentSearchesModal" class="full-recommendations-modal">
        <div class="full-recommendations-content">
            <div class="full-recommendations-header">
                <h3>
                    <i class="bi bi-clock-history"></i>
                    完整搜尋記錄
                </h3>
                <button type="button" class="modal-close-btn" onclick="closeRecentSearchesModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="full-recommendations-body">
                <div class="full-recommendation-section">
                    <h4 class="section-title">
                        <i class="bi bi-clock-history"></i>
                        近期搜尋
                        <span class="count" id="recentSearchModalCount">0</span>
                    </h4>
                    <div id="recentSearchModalContent" class="full-recommendations-container">
                        <!-- 動態載入 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 我的最愛完整清單模態框 -->
    <div id="favoritesModal" class="full-recommendations-modal">
        <div class="full-recommendations-content">
            <div class="full-recommendations-header">
                <h3>
                    <i class="bi bi-star-fill"></i>
                    完整最愛清單
                </h3>
                <button type="button" class="modal-close-btn" onclick="closeFavoritesModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="full-recommendations-body">
                <div class="full-recommendation-section">
                    <h4 class="section-title">
                        <i class="bi bi-star-fill"></i>
                        我的最愛
                        <span class="count" id="favoritesModalCount">0</span>
                    </h4>
                    <div id="favoritesModalContent" class="full-recommendations-container">
                        <!-- 動態載入 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let deleteId = null;

        // 頁面載入後自動滾動到指定的食物記錄
        document.addEventListener('DOMContentLoaded', function() {
            // 檢查 URL 中是否有錨點（例如：#food-123）
            const hash = window.location.hash;
            if (hash && hash.startsWith('#food-')) {
                // 延遲執行以確保頁面完全載入
                setTimeout(function() {
                    const element = document.querySelector(hash);
                    if (element) {
                        // 滾動到元素位置，並留一些上方空間
                        const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
                        const offsetPosition = elementPosition - 80; // 80px 是為了留出頂部空間
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                        
                        // 添加高亮效果
                        element.classList.add('highlight-card');
                        setTimeout(function() {
                            element.classList.remove('highlight-card');
                        }, 2000);
                    }
                }, 300);
            }
        });

        // 從卡片元素導航到編輯頁面
        function navigateToEditFromCard(element) {
            const foodId = element.dataset.foodId;
            const keyword = element.dataset.keyword;
            const page = element.dataset.page;
            
            navigateToEdit(foodId, keyword, page);
        }

        // 導航到編輯頁面，保留搜尋條件和分頁資訊
        function navigateToEdit(foodId, keyword, page) {
            let url = '/foods/' + foodId + '/edit?';
            const params = new URLSearchParams();
            
            // 保留搜尋關鍵字
            if (keyword && keyword !== 'null' && keyword !== '' && keyword !== 'undefined') {
                params.append('keyword', keyword);
            }
            
            // 保留當前頁碼
            if (page && page !== 'null' && page !== 'undefined') {
                params.append('page', page);
            }
            
            // 保留食物ID作為錨點
            params.append('foodId', foodId);
            
            window.location.href = url + params.toString();
        }

        function deleteFood(id) {
            deleteId = id;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteId = null;
        }

        function confirmDelete() {
            if (deleteId) {
                fetch(`/foods/${deleteId}`, {
                    method: 'DELETE'
                }).then(() => {
                    // 在重新載入前放置一個 sessionStorage 標記，讓 reload 後能顯示成功通知
                    try {
                        sessionStorage.setItem('deletedSuccess', '食物記錄已成功刪除');
                    } catch (e) {
                        // ignore
                    }
                    location.reload();
                }).catch(error => {
                    console.error('刪除失敗:', error);
                    alert('刪除失敗，請稍後再試');
                });
            }
            closeDeleteModal();
        }

        // 鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDeleteModal();
            }
        });

        // 點擊模態框外部關閉
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
        
        // 快速搜尋功能
        function searchFood(keyword) {
            const url = new URL(window.location.href);
            url.searchParams.set('keyword', keyword);
            url.searchParams.set('page', '0'); // 重置頁碼
            window.location.href = url.toString();
        }
        
        // 顯示近期搜尋完整清單
        function showRecentSearches() {
            const modal = document.getElementById('recentSearchesModal');
            if (modal) {
                modal.style.display = 'flex';
                loadRecentSearches();
            }
        }
        
        // 關閉近期搜尋模態框
        function closeRecentSearchesModal() {
            document.getElementById('recentSearchesModal').style.display = 'none';
        }
        
        // 顯示我的最愛完整清單
        function showAllFavorites() {
            const modal = document.getElementById('favoritesModal');
            if (modal) {
                modal.style.display = 'flex';
                loadAllFavorites();
            }
        }
        
        // 關閉我的最愛模態框
        function closeFavoritesModal() {
            document.getElementById('favoritesModal').style.display = 'none';
        }
        
        // 載入近期搜尋資料
        function loadRecentSearches() {
            fetch('/foods/recommendations')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentSearchModalContent');
                    const count = document.getElementById('recentSearchModalCount');
                    count.textContent = data.recentSearches.length;
                    
                    if (data.recentSearches.length === 0) {
                        container.innerHTML = '<p class="no-data">尚無搜尋記錄</p>';
                    } else {
                        container.innerHTML = data.recentSearches.map(search => 
                            `<button type="button" class="recommendation-tag recent-search" onclick="searchFood('${search}')">
                                <i class="bi bi-search"></i>
                                <span>${search}</span>
                            </button>`
                        ).join('');
                    }
                })
                .catch(error => {
                    console.error('載入搜尋記錄失敗:', error);
                });
        }
        
        // 載入我的最愛資料
        function loadAllFavorites() {
            fetch('/foods/recommendations')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('favoritesModalContent');
                    const count = document.getElementById('favoritesModalCount');
                    count.textContent = data.favorites.length;
                    
                    if (data.favorites.length === 0) {
                        container.innerHTML = '<p class="no-data">尚無收藏的食物</p>';
                    } else {
                        container.innerHTML = data.favorites.map(food => 
                            `<button type="button" class="recommendation-tag favorite-item" onclick="searchFood('${food.name}')">
                                <i class="bi bi-star-fill"></i>
                                <span>${food.name}</span>
                            </button>`
                        ).join('');
                    }
                })
                .catch(error => {
                    console.error('載入最愛清單失敗:', error);
                });
        }
        
        // 點擊模態框外部關閉
        document.addEventListener('DOMContentLoaded', function() {
            // 近期搜尋模態框外部點擊關閉
            document.getElementById('recentSearchesModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRecentSearchesModal();
                }
            });
            
            // 我的最愛模態框外部點擊關閉
            document.getElementById('favoritesModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFavoritesModal();
                }
            });
        });

        // 檢查 sessionStorage 是否有刪除成功的標記，若有則顯示通知並清除標記
        (function() {
            try {
                const msg = sessionStorage.getItem('deletedSuccess');
                if (msg) {
                    // 建立通知元素
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success';
                    notification.style.position = 'fixed';
                    notification.style.top = '20px';
                    notification.style.left = '50%';
                    notification.style.transform = 'translateX(-50%)';
                    notification.style.zIndex = '1100';
                    notification.style.padding = '12px 20px';
                    notification.style.borderRadius = '8px';
                    notification.textContent = msg;
                    document.body.appendChild(notification);

                    // 5 秒後自動消失
                    setTimeout(function() {
                        try { document.body.removeChild(notification); } catch(e) {}
                    }, 5000);

                    sessionStorage.removeItem('deletedSuccess');
                }
            } catch (e) {
                // ignore sessionStorage errors
            }
        })();
    </script>

    <style>
        /* 增強版食物卡片樣式 */
        .enhanced-card {
            position: relative;
            border: 2px solid #5174a8; /* Bootstrap primary 色 */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15), 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
            border-radius: var(--radius-xl);
        }
        
        .enhanced-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-300);
        }
        
        .favorite-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 20;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(245, 158, 11, 0.6);
            }
        }
        
        .food-card-image-wrapper {
            position: relative;
            overflow: hidden;
        }
        
        .enhanced-image {
            transition: transform 0.4s ease;
        }
        
        .enhanced-card:hover .enhanced-image {
            transform: scale(1.1);
        }
        
        .enhanced-placeholder {
            transition: all 0.4s ease;
        }
        
        .enhanced-card:hover .enhanced-placeholder {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%) !important;
        }
        
        .enhanced-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }
        
        .enhanced-content {
            padding: var(--space-5);
            background: linear-gradient(to bottom, white 0%, #fafafa 100%);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl); /* 只設定左下角和右下角的圓角 */
        }
        
        .food-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--space-4);
            color: #1a202c;
        }
        /* 份數徽章（圖片右上角） */
        .food-portion-badge-image {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            z-index: 3;
            display: flex;
            align-items: flex-start;
        }
        .food-portion-badge-image .food-unit {
            font-size: 1rem;
            color: var(--primary-600);
            background: rgba(243,244,246,0.8); /* #f3f4f6 80% 透明度 */
            border-radius: 1rem;
            padding: 0.1em 0.8em;
            font-weight: 700;
            white-space: nowrap;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        
        .food-name {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .carb-info-item {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            border: 2px solid var(--secondary-100);
            transition: all 0.2s ease;
        }
        
        .enhanced-card:hover .carb-info-item {
            border-color: var(--primary-200);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .carb-info-value {
            font-size: 1.5rem;
            font-weight: 800;
        }
        
        .carb-info-value.primary {
            color: #f97316;
        }
        
        .carb-info-value.success {
            color: #fb923c;
        }
        
        .edit-hint {
            transform: scale(0.9);
            transition: all 0.3s ease;
        }
        
        .enhanced-card:hover .edit-hint {
            transform: scale(1);
        }
        
        /* 模態框樣式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-content h3 {
            margin-bottom: var(--space-4);
            color: var(--secondary-800);
        }

        .modal-content p {
            margin-bottom: var(--space-6);
            color: var(--secondary-600);
        }

        .modal-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
        }

        /* 響應式調整 */
        @media (max-width: 767px) {
            .search-container form {
                flex-direction: column;
            }

            .food-card-content .flex {
                flex-direction: column;
            }

            .food-card-content .btn {
                justify-content: center;
            }
            
            .food-card-title {
                font-size: var(--font-size-lg);
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: var(--space-2);
                flex-wrap: wrap;
                margin-bottom: var(--space-3);
                line-height: 1.3;
            }
            
            .food-name {
                font-size: 2.25rem;
                font-weight: 700;
            }
            
            .food-unit {
                font-size: 0.9rem;
                font-weight: 600;
            }
        }

        /* 高亮卡片動畫 */
        .highlight-card {
            animation: highlightPulse 1s ease-in-out 2;
            box-shadow: 0 0 0 4px rgba(81, 116, 168, 0.3) !important;
        }
        
        @keyframes highlightPulse {
            0%, 100% {
                box-shadow: 0 0 0 4px rgba(81, 116, 168, 0.3);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(81, 116, 168, 0.5);
            }
        }
        
        /* 工具類 */
        .flex-1 { flex: 1; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .top-3 { top: var(--space-3); }
        .right-3 { right: var(--space-3); }
        .font-medium { font-weight: 500; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .text-primary-500 { color: var(--primary-500); }
        .text-primary-600 { color: var(--primary-600); }
        .text-secondary-400 { color: var(--secondary-400); }
        .text-secondary-500 { color: var(--secondary-500); }
        .text-secondary-600 { color: var(--secondary-600); }
        .text-success-500 { color: var(--success-500); }
        
        /* 食物卡片碳水資訊改善 */
        .food-card-carb-info {
            margin: var(--space-4) 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        /* 食物單位樣式 */
        .food-unit {
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-600);
            margin-left: var(--space-2);
            white-space: nowrap;
            display: inline;
        }
        
        .food-name {
            display: inline;
            font-size: 2.4rem;
            font-weight: 700;
            color: #2c3e50;
            letter-spacing: -0.025em;
        }
        
        .carb-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--secondary-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--secondary-200);
        }
        
        .carb-info-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-sm);
            color: var(--secondary-600);
        }
        
        .carb-info-value {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .carb-info-value span {
            font-weight: 700;
            font-size: var(--font-size-xl);
        }
        
        .carb-info-value.primary span {
            color: var(--primary-600);
        }
        
        .carb-info-value.success span {
            color: var(--success-600);
        }
        
        .carb-info-value small {
            font-size: var(--font-size-xs);
            color: var(--secondary-500);
            margin-top: 2px;
        }
        
        .carb-info-empty {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-sm);
            justify-content: center;
            width: 100%;
        }
        
        .food-card-notes-section {
            margin: var(--space-4) 0;
            padding: var(--space-3);
            background: var(--secondary-50);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--secondary-300);
        }
        
        .notes-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-xs);
            color: var(--secondary-600);
            margin-bottom: var(--space-2);
            font-weight: 500;
        }
        
        .food-card-notes {
            font-size: var(--font-size-sm);
            color: var(--secondary-700);
            line-height: 1.4;
            margin: 0;
        }
        
        .food-card-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--secondary-200);
        }
        
        .btn-outline-danger {
            background: transparent;
            color: var(--danger-500);
            border: 1px solid var(--danger-300);
        }
        
        .btn-outline-danger:hover {
            background: var(--danger-500);
            color: white;
            border-color: var(--danger-500);
        }
        
        /* 可點擊卡片樣式 */
        .clickable-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clickable-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .edit-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .clickable-card:hover .edit-overlay {
            opacity: 1;
        }
        
        .edit-hint {
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
        }
        
        .edit-hint i {
            font-size: 2rem;
        }
        
        .edit-hint span {
            font-weight: 500;
            font-size: var(--font-size-lg);
        }
        
        .quick-action-btn {
            z-index: 10;
            position: relative;
        }
        
        .edit-prompt {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-sm);
            flex: 1;
        }
        
        .food-card-actions {
            justify-content: space-between;
            align-items: center;
        }
        
        /* 分頁導航樣式 */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin: var(--space-8) 0;
        }
        
        .pagination {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            background: white;
            padding: var(--space-4);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--secondary-200);
        }
        
        .pagination-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: var(--primary-500);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-lg);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover {
            background: var(--primary-600);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .pagination-numbers {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            margin: 0 var(--space-4);
        }
        
        .pagination-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--secondary-100);
            color: var(--secondary-700);
            text-decoration: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .pagination-number:hover {
            background: var(--primary-100);
            color: var(--primary-700);
        }
        
        .pagination-current {
            background: var(--primary-500) !important;
            color: white !important;
        }
        
        .pagination-ellipsis {
            color: var(--secondary-400);
            padding: 0 var(--space-2);
        }
        
        /* 統計資訊樣式 */
        .stats-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .stats-main {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            flex-wrap: wrap;
        }
        
        .stats-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            white-space: nowrap;
        }
        
        .stats-filter {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        /* 搜尋推薦樣式 */
        .search-recommendations {
            margin-top: var(--space-4);
            padding: var(--space-4);
            background: var(--secondary-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--secondary-200);
        }
        
        .recommendation-section {
            margin-bottom: var(--space-4);
        }
        
        .recommendation-section:last-child {
            margin-bottom: 0;
        }
        
        .recommendation-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--secondary-600);
            margin-bottom: var(--space-3);
        }
        
        .recommendation-items {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .recommendation-tag {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-3);
            background: white;
            border: 1px solid var(--secondary-300);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            color: var(--secondary-700);
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .recommendation-tag:hover {
            background: var(--primary-100);
            color: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .recent-search:hover {
            background: var(--secondary-100);
            color: var(--secondary-800);
        }
        
        .favorite-item {
            background: var(--warning-50);
            border-color: var(--warning-200);
            color: var(--warning-700);
        }
        
        .favorite-item:hover {
            background: var(--warning-100);
            color: var(--warning-800);
        }
        
        .text-warning-500 {
            color: var(--warning-500);
        }
        
        /* 標題連結樣式 */
        .title-link {
            text-decoration: underline;
            /* 使用與「新增食物」按鈕相同的主色作為文字與底線顏色 */
            text-decoration-color: var(--primary-700);
            color: var(--primary-700) !important;
            text-underline-offset: 4px;
            transition: all 0.2s ease;
        }

        .title-link:hover {
            text-decoration-color: var(--primary-800);
            color: var(--primary-800) !important;
        }
        
        /* 連線狀態指示器樣式 */
        .connection-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .connection-indicator.online {
            background: var(--success-100, #dcfce7);
            color: var(--success-700, #15803d);
        }
        
        .connection-indicator.offline {
            background: var(--warning-100, #fef3c7);
            color: var(--warning-700, #a16207);
        }
        
        /* 離線橫幅 - 固定在頁面頂部 */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 500;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .offline-banner i {
            margin-right: 0.5rem;
        }
        
        /* 當離線橫幅顯示時，為 body 添加 padding-top */
        body.offline-mode {
            padding-top: 48px;
        }
        
        /* 快取狀態 */
        .cache-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: var(--secondary-100, #f3f4f6);
            border-radius: 999px;
            font-size: 0.875rem;
            color: var(--secondary-600, #4b5563);
        }
        
        .cache-status.cached {
            background: var(--primary-100, #dbeafe);
            color: var(--primary-700, #1d4ed8);
        }
        
        /* Header actions 響應式 */
        .header-row-1 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .header-row-2 {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
        }
        
        .header-row-3 {
            display: flex;
            gap: var(--space-3);
        }
        
        .logout-form {
            display: inline;
        }
        
        .refresh-btn {
            padding: 0.25rem 0.5rem;
        }
        
        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* 桌面版 header 佈局 */
        @media (min-width: 768px) {
            .page-header {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                justify-content: space-between;
                gap: var(--space-4);
            }
            
            .header-row-1 {
                flex: 1;
                min-width: 0;
            }
            
            .header-row-2 {
                order: 1;
            }
            
            .header-row-3 {
                order: 2;
            }
        }
        
        /* 手機版 header 佈局 */
        @media (max-width: 767px) {
            .page-header {
                display: flex;
                flex-direction: column;
                gap: var(--space-4);
            }
            
            .header-row-1 {
                width: 100%;
            }
            
            .header-row-1 .page-title {
                font-size: 1.25rem;
            }
            
            .header-row-2 {
                width: 100%;
                justify-content: center;
                gap: var(--space-2);
            }
            
            .header-row-3 {
                width: 100%;
                justify-content: center;
            }
            
            .header-row-3 .btn {
                flex: 1;
                max-width: 280px;
            }
            
            .connection-indicator,
            .cache-status {
                font-size: 0.75rem;
                padding: 0.2rem 0.5rem;
            }
            
            .logout-form .btn {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
        }
    </style>
    
    <!-- 離線搜尋功能 -->
    <script src="/js/offline-search.js"></script>
    
    <!-- Service Worker 註冊和離線狀態管理 -->
    <script>
        // 連線狀態管理（使用 WebSocket 連線檢測）
        const ConnectionManager = {
            lastOnlineState: null,
            browserOnline: navigator.onLine, // 瀏覽器網路狀態
            serverOnline: false, // 伺服器連線狀態
            websocket: null,
            reconnectTimeout: null,
            wsEndpoint: null, // 會在 init 時設定
            connectionConfirmed: false, // 是否已確認連線成功
            pingInterval: null, // 客戶端 ping 計時器
            pongTimeout: null, // 等待 pong 回應的計時器
            
            init() {
                // 設定 WebSocket 端點（自動判斷 ws 或 wss）
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.wsEndpoint = `${protocol}//${window.location.host}/ws/connection`;
                
                // 初始狀態：瀏覽器在線但伺服器還未確認
                this.browserOnline = navigator.onLine;
                this.serverOnline = false;
                
                // 初始不顯示離線狀態，等待 WebSocket 確認
                // 延遲 500ms 後如果還沒連線才顯示離線
                this.offlineDelayTimer = setTimeout(() => {
                    if (!this.serverOnline) {
                        this.updateUI(false);
                    }
                }, 500);
                console.log('[Connection] 初始化 - 瀏覽器:', this.browserOnline, '伺服器:', this.serverOnline, '（延遲顯示離線狀態）');
                
                // 使用 WebSocket 建立持久連線
                this.connectWebSocket();
                
                // 監聽瀏覽器的 online/offline 事件
                window.addEventListener('online', () => {
                    console.log('[Connection] 瀏覽器回報網路已連線');
                    this.browserOnline = true;
                    // 清除任何現有的重連計時器
                    if (this.reconnectTimeout) {
                        clearTimeout(this.reconnectTimeout);
                        this.reconnectTimeout = null;
                    }
                    // 立即嘗試連線伺服器
                    this.connectWebSocket();
                });
                
                window.addEventListener('offline', () => {
                    console.log('[Connection] 瀏覽器回報網路已斷線');
                    this.browserOnline = false;
                    // 瀏覽器離線，立即關閉 WebSocket 連線
                    this.closeWebSocket();
                    this.serverOnline = false;
                    this.connectionConfirmed = false;
                    this.updateConnectionState();
                });
                
                // 頁面可見性變化時重新連線
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        // 頁面恢復可見時，如果連線已斷開，嘗試重新連線
                        if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                            this.connectWebSocket();
                        }
                    }
                }, { passive: true });
                
                // 註冊 Service Worker
                this.registerServiceWorker();
            },
            
            closeWebSocket() {
                // 清理 ping/pong 計時器
                if (this.pingInterval) {
                    clearInterval(this.pingInterval);
                    this.pingInterval = null;
                }
                if (this.pongTimeout) {
                    clearTimeout(this.pongTimeout);
                    this.pongTimeout = null;
                }
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
            },
            
            connectWebSocket() {
                // 清理舊連線
                this.closeWebSocket();
                
                if (this.reconnectTimeout) {
                    clearTimeout(this.reconnectTimeout);
                    this.reconnectTimeout = null;
                }
                
                // 如果瀏覽器報告離線，不嘗試連線
                if (!navigator.onLine) {
                    console.log('[Connection] 瀏覽器報告離線，跳過 WebSocket 連線');
                    this.browserOnline = false;
                    this.serverOnline = false;
                    this.updateConnectionState();
                    return;
                }
                
                console.log('[Connection] 正在建立 WebSocket 連線...', this.wsEndpoint);
                this.connectionConfirmed = false;
                
                try {
                    this.websocket = new WebSocket(this.wsEndpoint);
                } catch (error) {
                    console.log('[Connection] 無法建立 WebSocket 連線:', error);
                    this.setServerOnline(false);
                    this.scheduleReconnect();
                    return;
                }
                
                // WebSocket 連線成功開啟
                this.websocket.onopen = () => {
                    console.log('[Connection] WebSocket 連線已建立');
                    this.connectionConfirmed = true;
                    this.setServerOnline(true);
                    this.startPing();
                };
                
                // WebSocket 收到訊息
                this.websocket.onmessage = (event) => {
                    const data = event.data;
                    console.log('[Connection] 收到訊息:', data);
                    
                    try {
                        const message = JSON.parse(data);
                        
                        if (message.type === 'pong') {
                            // 收到 pong，清除超時計時器
                            if (this.pongTimeout) {
                                clearTimeout(this.pongTimeout);
                                this.pongTimeout = null;
                            }
                        } else if (message.type === 'heartbeat') {
                            // 伺服器心跳，表示連線正常
                            console.log('[Connection] 收到伺服器心跳');
                        } else if (message.type === 'connected') {
                            // 連線確認訊息
                            console.log('[Connection] 收到連線確認');
                        } else if (message.type === 'data-updated') {
                            // 資料更新通知
                            console.log('[Connection] 收到資料更新通知');
                            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                                navigator.serviceWorker.controller.postMessage({
                                    type: 'CHECK_CACHE_VERSION'
                                });
                            }
                        }
                    } catch (e) {
                        // 非 JSON 格式，可能是舊版訊息
                        if (data === 'pong') {
                            if (this.pongTimeout) {
                                clearTimeout(this.pongTimeout);
                                this.pongTimeout = null;
                            }
                        }
                    }
                };
                
                // WebSocket 連線關閉 - 立即顯示離線狀態
                this.websocket.onclose = (event) => {
                    console.log('[Connection] WebSocket 連線已關閉，code:', event.code, 'reason:', event.reason);
                    // 立即顯示離線狀態
                    this.setServerOnline(false);
                    this.connectionConfirmed = false;
                    // 清理 ping/pong 計時器
                    if (this.pingInterval) {
                        clearInterval(this.pingInterval);
                        this.pingInterval = null;
                    }
                    if (this.pongTimeout) {
                        clearTimeout(this.pongTimeout);
                        this.pongTimeout = null;
                    }
                    this.scheduleReconnect();
                };
                
                // WebSocket 連線錯誤
                this.websocket.onerror = (error) => {
                    console.log('[Connection] WebSocket 連線錯誤');
                    // onclose 會被觸發，所以這裡不需要額外處理
                };
            },
            
            // 客戶端定期發送 ping 確認連線
            startPing() {
                // 每 15 秒發送一次 ping
                this.pingInterval = setInterval(() => {
                    if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        console.log('[Connection] 發送 ping');
                        this.websocket.send(JSON.stringify({ type: 'ping' }));
                        
                        // 設定 5 秒超時等待 pong
                        this.pongTimeout = setTimeout(() => {
                            console.log('[Connection] ping 超時未收到 pong，關閉連線');
                            this.closeWebSocket();
                            this.setServerOnline(false);
                            this.scheduleReconnect();
                        }, 5000);
                    }
                }, 15000);
            },
            
            scheduleReconnect() {
                if (this.reconnectTimeout) return; // 已經排程中
                
                // 如果瀏覽器報告離線，不排程重連
                if (!navigator.onLine) {
                    console.log('[Connection] 瀏覽器報告離線，暫不排程重連');
                    return;
                }
                
                // 固定 3 秒重試間隔
                const retryDelay = 3000;
                console.log(`[Connection] 將在 ${retryDelay / 1000} 秒後嘗試重新連線...`);
                
                this.reconnectTimeout = setTimeout(() => {
                    this.reconnectTimeout = null;
                    this.connectWebSocket();
                }, retryDelay);
            },
            
            // 設定伺服器連線狀態
            setServerOnline(online) {
                console.log('[Connection] setServerOnline:', online);
                this.serverOnline = online;
                
                // 清除延遲計時器
                if (this.offlineDelayTimer) {
                    clearTimeout(this.offlineDelayTimer);
                    this.offlineDelayTimer = null;
                }
                
                this.updateConnectionState();
            },
            
            // 計算並更新總體連線狀態
            // 在線條件：瀏覽器在線 AND 伺服器連線成功
            // 離線條件：瀏覽器離線 OR 伺服器離線
            updateConnectionState() {
                const isOnline = this.browserOnline && this.serverOnline;
                console.log('[Connection] updateConnectionState - 瀏覽器:', this.browserOnline, '伺服器:', this.serverOnline, '=> 總體:', isOnline);
                
                const wasOffline = this.lastOnlineState === false;
                const wasOnline = this.lastOnlineState === true;
                
                if (this.lastOnlineState === isOnline) return; // 狀態沒變，不處理
                
                this.lastOnlineState = isOnline;
                this.updateUI(isOnline);
                
                // 發送事件通知其他模組（如 OfflineSearchManager）
                window.dispatchEvent(new CustomEvent('connectionStateChanged', {
                    detail: { isOnline }
                }));
                
                if (isOnline) {
                    console.log('[Connection] 已連線（瀏覽器+伺服器都在線）');
                    // 只有從離線恢復時才顯示通知
                    if (wasOffline) {
                        this.showNotification('已恢復連線', 'success');
                    }
                    // 嘗試背景同步資料
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'CHECK_CACHE_VERSION'
                        });
                    }
                } else {
                    console.log('[Connection] 已離線（瀏覽器或伺服器離線）');
                    // 只有從線上變離線時才顯示通知
                    if (wasOnline) {
                        this.showNotification('連線已中斷，已切換至離線模式', 'warning');
                    }
                }
            },
            
            updateUI(isOnline) {
                console.log('[Connection] updateUI 被呼叫, isOnline:', isOnline);
                const indicator = document.getElementById('connectionIndicator');
                const banner = document.getElementById('offlineBanner');
                const refreshCacheBtn = document.getElementById('refreshCacheBtn');
                
                console.log('[Connection] indicator 元素:', indicator);
                
                if (indicator) {
                    if (isOnline) {
                        indicator.className = 'connection-indicator online';
                        indicator.innerHTML = '<i class="bi bi-wifi"></i> 線上';
                    } else {
                        indicator.className = 'connection-indicator offline';
                        indicator.innerHTML = '<i class="bi bi-wifi-off"></i> 離線';
                    }
                    console.log('[Connection] indicator 已更新為:', isOnline ? '線上' : '離線');
                } else {
                    console.warn('[Connection] 找不到 connectionIndicator 元素！');
                }
                
                if (banner) {
                    if (isOnline) {
                        banner.style.display = 'none';
                        document.body.classList.remove('offline-mode');
                    } else {
                        banner.style.display = 'block';
                        document.body.classList.add('offline-mode');
                    }
                }
                
                // 控制更新快取按鈕
                if (refreshCacheBtn) {
                    if (isOnline) {
                        refreshCacheBtn.disabled = false;
                        refreshCacheBtn.title = '更新離線快取';
                    } else {
                        refreshCacheBtn.disabled = true;
                        refreshCacheBtn.title = '離線時無法更新快取';
                    }
                }
            },
            
            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'success' ? 'success' : 'warning'}`;
                // 計算 top 位置：如果有離線橫幅，要加上橫幅高度
                const topOffset = document.body.classList.contains('offline-mode') ? 68 : 20;
                notification.style.cssText = `
                    position: fixed;
                    top: ${topOffset}px;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 1100;
                    padding: 12px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: slideDown 0.3s ease;
                    min-width: 280px;
                    max-width: 90vw;
                    text-align: center;
                    white-space: nowrap;
                `;
                notification.innerHTML = `<i class="bi bi-${type === 'success' ? 'wifi' : 'wifi-off'}"></i> ${message}`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            },
            
            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('[SW] Service Worker 註冊成功:', registration.scope);
                        
                        // 監聽 Service Worker 訊息
                        navigator.serviceWorker.addEventListener('message', (event) => {
                            this.handleSWMessage(event.data);
                        });
                        
                        // 等待 Service Worker 啟動後預載資料
                        if (registration.active) {
                            this.initOfflineData();
                        } else {
                            navigator.serviceWorker.ready.then(() => {
                                this.initOfflineData();
                            });
                        }
                    } catch (error) {
                        console.error('[SW] Service Worker 註冊失敗:', error);
                    }
                }
            },
            
            handleSWMessage(data) {
                switch (data.type) {
                    case 'PREFETCH_PROGRESS':
                        this.updateCacheStatus(data.message);
                        break;
                    case 'PREFETCH_COMPLETE':
                        this.updateCacheStatus(`已快取 ${data.totalFoods} 筆食物`);
                        document.getElementById('cacheStatus').classList.add('cached');
                        break;
                    case 'BACKGROUND_SYNC_COMPLETE':
                        this.showNotification('快取資料已更新', 'success');
                        break;
                    case 'CACHE_VERSION_INFO':
                        if (data.needsUpdate) {
                            this.showNotification('有新資料可用，點擊更新按鈕同步', 'warning');
                        }
                        break;
                }
            },
            
            updateCacheStatus(message) {
                const status = document.getElementById('cacheStatus');
                if (status) {
                    status.innerHTML = `<i class="bi bi-database-check"></i> ${message}`;
                }
            },
            
            initOfflineData() {
                // 檢查是否已有快取
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'GET_CACHED_DATA'
                    });
                }
            }
        };
        
        // 更新快取按鈕功能
        document.getElementById('refreshCacheBtn')?.addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
            
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'PREFETCH_ALL_DATA'
                });
                
                // 等待一段時間後恢復按鈕
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                }, 5000);
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                alert('Service Worker 尚未就緒，請稍後再試');
            }
        });
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', () => {
            ConnectionManager.init();
        });
        
        // 動畫樣式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from { opacity: 0; transform: translate(-50%, -20px); }
                to { opacity: 1; transform: translate(-50%, 0); }
            }
            @keyframes slideUp {
                from { opacity: 1; transform: translate(-50%, 0); }
                to { opacity: 0; transform: translate(-50%, -20px); }
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            .spin {
                animation: spin 1s linear infinite;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
