<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${food.id == null ? '新增食物 - 食物歷史' : '編輯食物 - 食物歷史'}">新增/編輯食物</title>
    <link href="/css/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>
    <!-- 離線橫幅 -->
    <div id="offlineBanner" class="offline-banner">
        <i class="bi bi-wifi-off"></i>
        您目前處於離線模式，無法新增、修改或刪除資料
    </div>
    <div class="container fade-in">
        <!-- 頁面標題 -->
        <header class="page-header">
            <div class="header-left">
                <h1 class="page-title">
                    <i class="bi bi-journal-plus"></i>
                    <span th:text="${food.id == null ? '新增食物' : '編輯食物'}">新增/編輯食物</span>
                </h1>
                <!-- 連線狀態指示器 -->
                <div id="connectionIndicator" class="connection-indicator online">
                    <i class="bi bi-wifi"></i> 線上
                </div>
            </div>
            <div class="flex gap-3">
                <a href="#" 
                   onclick="event.preventDefault(); goBackToList();" 
                   class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i>
                    返回列表
                </a>
                <button th:if="${food.id != null}" 
                        type="button" 
                        class="btn favorite-btn"
                        th:classappend="${food.isFavorite} ? 'favorite-btn-active' : 'favorite-btn-inactive'"
                        th:onclick="'toggleFavorite(' + ${food.id} + ')'"
                        id="favoriteBtn">
                    <div class="favorite-btn-content">
                        <i class="bi favorite-icon" th:classappend="${food.isFavorite} ? 'bi-star-fill' : 'bi-star'"></i>
                        <span class="favorite-text" th:text="${food.isFavorite} ? '已收藏' : '加入最愛'">最愛</span>
                    </div>
                </button>
                <button th:if="${food.id != null}" 
                        type="button" 
                        class="btn btn-danger" 
                        id="deleteBtn"
                        th:onclick="'deleteFood(' + ${food.id} + ')'">
                    <i class="bi bi-trash"></i>
                    刪除
                </button>
            </div>
        </header>

        <!-- 提示訊息 -->
        <div th:if="${error}" class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <span th:text="${error}"></span>
        </div>
        
        <div th:if="${success}" class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <span th:text="${success}"></span>
        </div>

        <!-- 表單容器 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 左側：圖片上傳 -->
            <div class="lg:col-span-1">
                <div class="card slide-in">
                    <div class="card-header">
                        <h3 class="flex items-center gap-2 font-semibold">
                            <i class="bi bi-camera text-primary-500"></i>
                            食物圖片
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="image-upload-area" onclick="document.getElementById('imageFile').click()">
                            <input type="file" 
                                   class="hidden" 
                                   id="imageFile" 
                                   name="imageFile" 
                                   accept="image/*" 
                                   onchange="previewImage(this)"
                                   form="foodForm">
                            
                            <div id="uploadPlaceholder" th:style="${hasImage ? 'display: none;' : ''}">
                                <i class="bi bi-cloud-upload upload-icon"></i>
                                <p class="upload-text">點擊或拖曳上傳圖片</p>
                                <p class="upload-hint">支援 JPEG、PNG 或 GIF 格式</p>
                            </div>
                            
                            <div th:if="${hasImage}" class="image-preview-container">
                                <img th:src="@{'/foods/images/' + ${food.imagePath}}" class="image-preview" id="imagePreview">
                                <button type="button" class="image-remove-btn" onclick="removeImage(event)" title="移除圖片">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>                        <div id="uploadProgress" class="progress-bar hidden">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：表單資料 -->
            <div class="lg:col-span-2">
                <form id="foodForm" th:action="@{/foods}" method="post" enctype="multipart/form-data" th:object="${food}" novalidate>
                    <input type="hidden" th:field="*{id}">
                    <input type="hidden" th:field="*{imagePath}">
                    <input type="hidden" th:field="*{imageContentType}">
                    <input type="hidden" id="returnKeyword" name="returnKeyword" th:value="${returnKeyword}" />
                    <input type="hidden" id="returnPage" name="returnPage" th:value="${returnPage}" />
                    <input type="hidden" id="returnFoodId" name="returnFoodId" th:value="${returnFoodId}" />
                    <input type="hidden" id="removeImageFlag" name="removeImage" value="false">
                    
                    <!-- 基本資訊 -->
                    <div class="card slide-in" style="animation-delay: 0.1s;">
                        <div class="card-header">
                            <h3 class="flex items-center gap-2 font-semibold">
                                <i class="bi bi-info-circle text-primary-500"></i>
                                基本資訊
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="name" class="form-label">
                                    食物名稱 <span class="text-danger-500">*</span>
                                </label>
                                <div class="name-unit-container">
                                    <div class="input-with-icon name-input-wrapper">
                                        <i class="bi bi-tag input-icon"></i>
                                        <input type="text" 
                                               class="form-control input-with-icon-padding food-name-input" 
                                               id="name" 
                                               th:field="*{name}" 
                                               required 
                                               maxlength="30" 
                                               placeholder="例如：白米飯、蘋果...">
                                    </div>
                                    <div class="quantity-unit-group">
                                        <div class="quantity-input">
                                            <input type="number" 
                                                   class="form-control quantity-number" 
                                                   th:field="*{quantity}" 
                                                   id="quantity"
                                                   min="0.5" 
                                                   max="999" 
                                                   step="0.5"
                                                   placeholder="數量">
                                        </div>
                                        <div class="unit-selector">
                                            <select class="form-control unit-select" th:field="*{unit}" id="unit">
                                                <option value="">選擇單位</option>
                                                <option value="個">個</option>
                                                <option value="顆">顆</option>
                                                <option value="包">包</option>
                                                <option value="盒">盒</option>
                                                <option value="塊">塊</option>
                                                <option value="份">份</option>
                                                <option value="碗">碗</option>
                                                <option value="杯">杯</option>
                                                <option value="條">條</option>
                                                <option value="片">片</option>
                                                <option value="隻">隻</option>
                                                <option value="克">克</option>
                                                <option value="cc">cc</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-secondary-500">
                                    可選填：設定數量和單位，例如「1顆」、「2包」
                                </small>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-group">
                                    <label for="coefficient" class="form-label">
                                        系數（可選）
                                        <span class="tooltip-icon" title="每100克食物中碳水系數，例如：白米飯約0.23（23%）">
                                            <i class="bi bi-info-circle"></i>
                                        </span>
                                    </label>
                                    <div class="input-with-icon">
                                        <i class="bi bi-percent input-icon"></i>
                                        <input type="number" 
                                               class="form-control input-with-icon-padding carb-input" 
                                               id="coefficient" 
                                               th:field="*{coefficient}" 
                                               min="0" 
                                               max="1" 
                                               step="0.01" 
                                               placeholder="例如：0.23（表示23%）">
                                    </div>
                                    <small class="text-secondary-500">
                                        輸入0-1之間的數值，例如：0.25代表25%
                                        <br><strong>常見食物參考：</strong>白米飯0.23、蘋果0.14、香蕉0.23
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="carbGrams" class="form-label">
                                        碳水化合物 (克)（可選）
                                        <span class="tooltip-icon" title="這份食物實際含有多少克碳水化合物">
                                            <i class="bi bi-info-circle"></i>
                                        </span>
                                    </label>
                                    <div class="input-with-icon">
                                        <i class="bi bi-graph-up input-icon"></i>
                                        <input type="number" 
                                               class="form-control input-with-icon-padding carb-input" 
                                               id="carbGrams" 
                                               th:field="*{carbGrams}" 
                                               min="0.1" 
                                               max="999" 
                                               step="0.1"
                                               placeholder="例如：25.5">
                                    </div>
                                    <small class="text-secondary-500">
                                        這份食物的碳水化合物克數（可含小數點）
                                    </small>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-lightbulb"></i>
                                <div>
                                    <strong>填寫說明：</strong>
                                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                                        <li><strong>系數：</strong>適合經常食用的食物，一次設定後可重複使用</li>
                                        <li><strong>碳水化合物：</strong>適合包裝食品或已知確切含量的食物</li>
                                        <li><strong>至少需要填寫一項</strong>，也可以兩者都填寫</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 備註資訊 -->
                    <div class="card slide-in" style="animation-delay: 0.2s;">
                        <div class="card-header">
                            <h3 class="flex items-center gap-2 font-semibold">
                                <i class="bi bi-chat-text text-primary-500"></i>
                                備註資訊
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="notes" class="form-label">備註</label>
                                <textarea class="form-control" 
                                          id="notes" 
                                          th:field="*{notes}" 
                                          maxlength="100" 
                                          rows="4" 
                                          placeholder="記錄一些特殊說明或提醒事項..."></textarea>
                                <div class="flex justify-between" style="margin-top: var(--space-2);">
                                    <small class="text-secondary-500">選填項目</small>
                                    <small class="text-secondary-500" id="notesCounter">0/100</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按鈕 -->
                    <div class="card slide-in" style="animation-delay: 0.25s;">
                        <div class="card-body">
                            <div class="flex flex-col gap-4 justify-end">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-save"></i>
                                    <span th:text="${food.id == null ? '新增食物' : '更新食物'}">儲存</span>
                                </button>
                                <a href="#" 
                                   onclick="event.preventDefault(); goBackToList();" 
                                   class="btn btn-cancel btn-lg">
                                    <i class="bi bi-x-lg"></i>
                                    取消
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 底部間距 -->
        <div style="height: var(--space-16);"></div>
    </div>

    <script>
        // 儲存從列表頁面帶過來的搜尋條件和分頁資訊
        let returnParams = {
            keyword: '',
            page: 0,
            foodId: ''
        };
        
        // 頁面載入時取得 URL 參數
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 取得搜尋關鍵字
            if (urlParams.has('keyword')) {
                returnParams.keyword = urlParams.get('keyword');
                document.getElementById('returnKeyword').value = returnParams.keyword;
            }
            
            // 取得頁碼
            if (urlParams.has('page')) {
                returnParams.page = urlParams.get('page');
                document.getElementById('returnPage').value = returnParams.page;
            }
            
            // 取得食物 ID
            if (urlParams.has('foodId')) {
                returnParams.foodId = urlParams.get('foodId');
                document.getElementById('returnFoodId').value = returnParams.foodId;
            }
        });
        
        // 返回列表頁面並保留搜尋條件、分頁和錨點
        function goBackToList() {
            let url = '/foods?';
            const params = new URLSearchParams();
            
            // 保留搜尋關鍵字
            if (returnParams.keyword) {
                params.append('keyword', returnParams.keyword);
            }
            
            // 保留頁碼
            if (returnParams.page) {
                params.append('page', returnParams.page);
            }
            
            // 添加錨點
            let anchor = '';
            if (returnParams.foodId) {
                anchor = '#food-' + returnParams.foodId;
            }
            
            window.location.href = url + params.toString() + anchor;
        }
        
        // 攔截 HTML5 原生驗證訊息，改用自訂訊息
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('foodForm');
            const inputs = form.querySelectorAll('input[type="number"], input[required]');
            
            inputs.forEach(input => {
                input.addEventListener('invalid', function(e) {
                    e.preventDefault();
                    
                    let message = '';
                    const fieldName = this.id;
                    
                    if (this.validity.valueMissing) {
                        message = '請輸入' + this.previousElementSibling?.textContent || '此欄位';
                    } else if (this.validity.rangeUnderflow) {
                        message = `${this.previousElementSibling?.textContent || '此欄位'}不能小於 ${this.min}`;
                    } else if (this.validity.rangeOverflow) {
                        message = `${this.previousElementSibling?.textContent || '此欄位'}不能大於 ${this.max}`;
                    } else if (this.validity.stepMismatch) {
                        message = `${this.previousElementSibling?.textContent || '此欄位'}必須是 ${this.step} 的倍數`;
                    }
                    
                    if (message) {
                        showValidationError(message, fieldName);
                    }
                });
            });
        });
        
        // 圖片預覽功能
        // 圖片預覽功能（含驗證）
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const maxSize = 20 * 1024 * 1024; // 20MB
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                
                // 檢查檔案大小
                if (file.size > maxSize) {
                    showValidationError('圖片檔案太大，請選擇小於 20MB 的圖片');
                    input.value = '';
                    return;
                }
                
                // 檢查檔案類型
                if (!allowedTypes.includes(file.type)) {
                    showValidationError('不支援的圖片格式，請選擇 JPEG、PNG、GIF 或 WebP 格式');
                    input.value = '';
                    return;
                }
                
                // 驗證通過,開始預覽
                const reader = new FileReader();
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                const progressBar = document.getElementById('uploadProgress');
                
                // 顯示進度條
                progressBar.classList.remove('hidden');
                const progressFill = progressBar.querySelector('.progress-fill');
                
                reader.onloadstart = function() {
                    progressFill.style.width = '0%';
                };
                
                reader.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentLoaded = Math.round((e.loaded / e.total) * 100);
                        progressFill.style.width = percentLoaded + '%';
                    }
                };
                
                reader.onload = function(e) {
                    progressFill.style.width = '100%';
                    setTimeout(() => {
                        // 隱藏上傳提示
                        uploadPlaceholder.style.display = 'none';
                        
                        // 移除現有的圖片預覽容器
                        const existingContainer = document.querySelector('.image-preview-container');
                        if (existingContainer) {
                            existingContainer.remove();
                        }
                        
                        // 創建新的圖片預覽容器
                        const container = document.createElement('div');
                        container.className = 'image-preview-container';
                        
                        const img = document.createElement('img');
                        img.id = 'imagePreview';
                        img.className = 'image-preview';
                        img.src = e.target.result;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'image-remove-btn';
                        removeBtn.title = '移除圖片';
                        removeBtn.onclick = function(event) { removeImage(event); };
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        
                        container.appendChild(img);
                        container.appendChild(removeBtn);
                        document.querySelector('.image-upload-area').appendChild(container);
                        
                        progressBar.classList.add('hidden');
                    }, 500);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // 移除圖片功能
        function removeImage(event) {
            event.stopPropagation();
            
            // 清除檔案輸入
            document.getElementById('imageFile').value = '';
            
            // 設定移除旗標
            document.getElementById('removeImageFlag').value = 'true';
            
            // 清空隱藏欄位（重要：讓後端知道要刪除圖片）
            const imagePathInput = document.querySelector('input[name="imagePath"]');
            const imageContentTypeInput = document.querySelector('input[name="imageContentType"]');
            if (imagePathInput) imagePathInput.value = '';
            if (imageContentTypeInput) imageContentTypeInput.value = '';
            
            // 移除圖片預覽容器
            const container = document.querySelector('.image-preview-container');
            if (container) {
                container.remove();
            }
            
            // 顯示上傳提示
            document.getElementById('uploadPlaceholder').style.display = 'block';
        }
        
        // 拖拽上傳功能
        const uploadArea = document.querySelector('.image-upload-area');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
            uploadArea.classList.add('dragover');
        }
        
        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }
        
        uploadArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                document.getElementById('imageFile').files = files;
                previewImage(document.getElementById('imageFile'));
            }
        }
        
        // 備註字數統計
        const notesTextarea = document.getElementById('notes');
        const notesCounter = document.getElementById('notesCounter');
        
        notesTextarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            notesCounter.textContent = currentLength + '/100';
            
            if (currentLength > 80) {
                notesCounter.style.color = 'var(--warning-500)';
            } else {
                notesCounter.style.color = 'var(--secondary-500)';
            }
        });
        
        // 初始化字數統計
        if (notesTextarea.value) {
            notesCounter.textContent = notesTextarea.value.length + '/100';
        }
        
        // 顯示驗證錯誤提示的通用函數
        function showValidationError(message, fieldId = null) {
            console.log('顯示驗證錯誤:', message, fieldId); // 除錯用
            
            // 移除舊的錯誤提示
            const oldAlert = document.querySelector('.validation-error-alert');
            if (oldAlert) {
                oldAlert.remove();
            }
            
            // 顯示錯誤提示（固定在頂部）
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger validation-error-alert fixed-top-alert';
            errorAlert.innerHTML = `
                <div class="alert-content">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span>${message}</span>
                </div>
                <button type="button" class="alert-close-btn" onclick="this.parentElement.remove()">
                    <i class="bi bi-x-lg"></i>
                </button>
            `;
            
            // 直接加入 body 並固定在頂部
            document.body.appendChild(errorAlert);
            
            // 如果指定了欄位，則標記該欄位並滾動到該位置
            if (fieldId) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.add('input-error');
                    
                    // 延遲聚焦，確保動畫完成
                    setTimeout(() => {
                        field.focus();
                        // 滾動到錯誤欄位
                        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                    
                    // 當使用者修改欄位時移除錯誤樣式
                    field.addEventListener('input', function() {
                        field.classList.remove('input-error');
                    }, { once: true });
                }
            } else {
                // 沒有指定欄位時滾動到頂部
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            // 5秒後自動移除提示
            setTimeout(() => {
                if (errorAlert.parentNode) {
                    errorAlert.remove();
                }
            }, 5000);
        }
        
        // 表單驗證
        document.getElementById('foodForm').addEventListener('submit', function(event) {
            // 離線時阻止提交
            if (!navigator.onLine) {
                event.preventDefault();
                showValidationError('您目前處於離線模式，無法儲存資料。請等待網路恢復後再試。');
                return false;
            }
            
            // 清除所有錯誤樣式
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

            const name = document.getElementById('name').value.trim();
            const quantity = document.getElementById('quantity').value;
            const coefficient = document.getElementById('coefficient').value;
            const carbGrams = document.getElementById('carbGrams').value;

            // 驗證必填欄位
            if (!name) {
                event.preventDefault();
                showValidationError('請輸入食物名稱', 'name');
                return false;
            }

            // 驗證數量格式（如果有填寫）
            if (quantity) {
                const quantityNum = parseFloat(quantity);
                if (isNaN(quantityNum)) {
                    event.preventDefault();
                    showValidationError('數量格式不正確，請輸入有效的數字', 'quantity');
                    return false;
                }
                if (quantityNum < 0.5) {
                    event.preventDefault();
                    showValidationError('數量不能小於 0.5', 'quantity');
                    return false;
                }
                if (quantityNum > 999) {
                    event.preventDefault();
                    showValidationError('數量不能大於 999', 'quantity');
                    return false;
                }
                // 檢查是否為 0.5 的倍數
                const remainder = (quantityNum * 10) % 5;
                if (remainder !== 0) {
                    event.preventDefault();
                    showValidationError('數量必須是 0.5 的倍數（例如：0.5、1、1.5、2、2.5...）', 'quantity');
                    return false;
                }
            }

            // 驗證系數格式（如果有填寫）
            let hasCoefficient = false;
            if (coefficient !== "" && coefficient !== null) {
                const coefficientNum = parseFloat(coefficient);
                if (!isNaN(coefficientNum)) {
                    hasCoefficient = true;
                    if (coefficientNum < 0) {
                        event.preventDefault();
                        showValidationError('系數不能小於 0', 'coefficient');
                        return false;
                    }
                    if (coefficientNum > 1) {
                        event.preventDefault();
                        showValidationError('系數不能大於 1', 'coefficient');
                        return false;
                    }
                } else {
                    event.preventDefault();
                    showValidationError('系數格式不正確，請輸入有效的數字', 'coefficient');
                    return false;
                }
            }

            // 驗證碳水化合物格式（如果有填寫）
            let hasCarb = false;
            if (carbGrams !== "" && carbGrams !== null) {
                const carbGramsNum = parseFloat(carbGrams);
                if (!isNaN(carbGramsNum)) {
                    hasCarb = true;
                    // 只有 carbGrams 不是 0.0 才檢查最小值
                    if (carbGramsNum !== 0.0 && carbGramsNum < 0.1) {
                        event.preventDefault();
                        showValidationError('碳水化合物不能小於 0.1', 'carbGrams');
                        return false;
                    }
                    if (carbGramsNum > 999) {
                        event.preventDefault();
                        showValidationError('碳水化合物不能大於 999', 'carbGrams');
                        return false;
                    }
                } else {
                    event.preventDefault();
                    showValidationError('碳水化合物格式不正確，請輸入有效的數字', 'carbGrams');
                    return false;
                }
            }

            // 驗證至少填寫系數或碳水化合物其中一項（0.0 也算有填）
            if (!hasCoefficient && !hasCarb) {
                event.preventDefault();
                showValidationError('請至少填寫系數或碳水化合物其中一項', 'coefficient');
                return false;
            }

            // 所有驗證通過，允許提交
            return true;
        });

        // 刪除功能
        function deleteFood(id) {
            // 離線時阻止刪除
            if (!navigator.onLine) {
                showValidationError('您目前處於離線模式，無法刪除資料。請等待網路恢復後再試。');
                return;
            }
            
            if (confirm('您確定要刪除這個食物記錄嗎？此操作無法復原。')) {
                fetch(`/foods/${id}`, {
                    method: 'DELETE'
                }).then(() => {
                    // 刪除成功後，導航回列表並捲動到下一筆（原本的上一筆）
                    let url = '/foods?';
                    const params = new URLSearchParams();
                    
                    // 保留搜尋關鍵字
                    if (returnParams.keyword) {
                        params.append('keyword', returnParams.keyword);
                    }
                    
                    // 保留頁碼
                    if (returnParams.page) {
                        params.append('page', returnParams.page);
                    }
                    
                    // 刪除後，捲動到下一筆（ID + 1，因為列表是降序排列）
                    const nextFoodId = parseInt(id) + 1;
                    const anchor = '#food-' + nextFoodId;
                    
                    window.location.href = url + params.toString() + anchor;
                }).catch(error => {
                    console.error('刪除失敗:', error);
                    alert('刪除失敗，請稍後再試');
                });
            }
        }

        // 切換最愛功能
        function toggleFavorite(id) {
            // 離線時阻止操作
            if (!navigator.onLine) {
                showValidationError('您目前處於離線模式，無法變更收藏狀態。請等待網路恢復後再試。');
                return;
            }
            
            const btn = document.getElementById('favoriteBtn');
            const icon = btn.querySelector('.favorite-icon');
            const text = btn.querySelector('.favorite-text');
            
            fetch(`/foods/${id}/toggle-favorite`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.isFavorite) {
                        // 切換到已收藏狀態
                        btn.classList.remove('favorite-btn-inactive');
                        btn.classList.add('favorite-btn-active');
                        icon.className = 'bi bi-star-fill favorite-icon';
                        text.textContent = '已收藏';
                    } else {
                        // 切換到未收藏狀態
                        btn.classList.remove('favorite-btn-active');
                        btn.classList.add('favorite-btn-inactive');
                        icon.className = 'bi bi-star favorite-icon';
                        text.textContent = '加入最愛';
                    }
                } else {
                    alert('操作失敗，請稍後再試');
                }
            })
            .catch(error => {
                console.error('切換最愛失敗:', error);
                alert('操作失敗，請稍後再試');
            });
        }

        // 連線狀態管理（使用 WebSocket）
        const ConnectionManager = {
            lastOnlineState: null,
            browserOnline: navigator.onLine, // 瀏覽器網路狀態
            serverOnline: false, // 伺服器連線狀態
            websocket: null,
            reconnectTimeout: null,
            wsEndpoint: null, // 會在 init 時設定
            connectionConfirmed: false, // 是否已確認連線成功
            pingInterval: null, // 客戶端 ping 計時器
            pongTimeout: null, // 等待 pong 回應的計時器
            
            init() {
                // 設定 WebSocket 端點（自動判斷 ws 或 wss）
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.wsEndpoint = `${protocol}//${window.location.host}/ws/connection`;
                
                // 初始狀態：瀏覽器在線但伺服器還未確認
                this.browserOnline = navigator.onLine;
                this.serverOnline = false;
                
                // 初始不顯示任何狀態，等 WebSocket 確認後才更新 UI
                console.log('[Connection] 初始化 - 瀏覽器:', this.browserOnline, '伺服器:', this.serverOnline, '（等待 WebSocket 確認）');
                
                // 使用 WebSocket 建立持久連線
                this.connectWebSocket();
                
                // 監聯瀏覽器的 online/offline 事件
                window.addEventListener('online', () => {
                    console.log('[Connection] 瀏覽器回報網路已連線');
                    this.browserOnline = true;
                    // 清除任何現有的重連計時器
                    if (this.reconnectTimeout) {
                        clearTimeout(this.reconnectTimeout);
                        this.reconnectTimeout = null;
                    }
                    // 立即嘗試連線伺服器
                    this.connectWebSocket();
                });
                
                window.addEventListener('offline', () => {
                    console.log('[Connection] 瀏覽器回報網路已斷線');
                    this.browserOnline = false;
                    // 瀏覽器離線，立即關閉 WebSocket 連線
                    this.closeWebSocket();
                    this.serverOnline = false;
                    this.connectionConfirmed = false;
                    this.updateConnectionState();
                });
                
                // 頁面可見性變化時重新連線
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        // 頁面恢復可見時，如果連線已斷開，嘗試重新連線
                        if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                            this.connectWebSocket();
                        }
                    }
                }, { passive: true });
            },
            
            closeWebSocket() {
                // 清理 ping/pong 計時器
                if (this.pingInterval) {
                    clearInterval(this.pingInterval);
                    this.pingInterval = null;
                }
                if (this.pongTimeout) {
                    clearTimeout(this.pongTimeout);
                    this.pongTimeout = null;
                }
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
            },
            
            connectWebSocket() {
                // 清理舊連線
                this.closeWebSocket();
                
                if (this.reconnectTimeout) {
                    clearTimeout(this.reconnectTimeout);
                    this.reconnectTimeout = null;
                }
                
                // 如果瀏覽器報告離線，不嘗試連線
                if (!navigator.onLine) {
                    console.log('[Connection] 瀏覽器報告離線，跳過 WebSocket 連線');
                    this.browserOnline = false;
                    this.serverOnline = false;
                    this.updateConnectionState();
                    return;
                }
                
                console.log('[Connection] 正在建立 WebSocket 連線...', this.wsEndpoint);
                this.connectionConfirmed = false;
                
                try {
                    this.websocket = new WebSocket(this.wsEndpoint);
                } catch (error) {
                    console.log('[Connection] 無法建立 WebSocket 連線:', error);
                    this.setServerOnline(false);
                    this.scheduleReconnect();
                    return;
                }
                
                // WebSocket 連線成功開啟
                this.websocket.onopen = () => {
                    console.log('[Connection] WebSocket 連線已建立');
                    this.connectionConfirmed = true;
                    this.setServerOnline(true);
                    this.startPing();
                };
                
                // WebSocket 收到訊息
                this.websocket.onmessage = (event) => {
                    const data = event.data;
                    console.log('[Connection] 收到訊息:', data);
                    
                    try {
                        const message = JSON.parse(data);
                        
                        if (message.type === 'pong') {
                            // 收到 pong，清除超時計時器
                            if (this.pongTimeout) {
                                clearTimeout(this.pongTimeout);
                                this.pongTimeout = null;
                            }
                        } else if (message.type === 'heartbeat') {
                            // 伺服器心跳，表示連線正常
                            console.log('[Connection] 收到伺服器心跳');
                        } else if (message.type === 'connected') {
                            // 連線確認訊息
                            console.log('[Connection] 收到連線確認');
                        }
                    } catch (e) {
                        // 非 JSON 格式，可能是舊版訊息
                        if (data === 'pong') {
                            if (this.pongTimeout) {
                                clearTimeout(this.pongTimeout);
                                this.pongTimeout = null;
                            }
                        }
                    }
                };
                
                // WebSocket 連線關閉 - 立即顯示離線狀態
                this.websocket.onclose = (event) => {
                    console.log('[Connection] WebSocket 連線已關閉，code:', event.code, 'reason:', event.reason);
                    // 立即顯示離線狀態
                    this.setServerOnline(false);
                    this.connectionConfirmed = false;
                    // 清理 ping/pong 計時器
                    if (this.pingInterval) {
                        clearInterval(this.pingInterval);
                        this.pingInterval = null;
                    }
                    if (this.pongTimeout) {
                        clearTimeout(this.pongTimeout);
                        this.pongTimeout = null;
                    }
                    this.scheduleReconnect();
                };
                
                // WebSocket 連線錯誤
                this.websocket.onerror = (error) => {
                    console.log('[Connection] WebSocket 連線錯誤');
                    // onclose 會被觸發，所以這裡不需要額外處理
                };
            },
            
            // 客戶端定期發送 ping 確認連線
            startPing() {
                // 每 15 秒發送一次 ping
                this.pingInterval = setInterval(() => {
                    if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        console.log('[Connection] 發送 ping');
                        this.websocket.send(JSON.stringify({ type: 'ping' }));
                        
                        // 設定 5 秒超時等待 pong
                        this.pongTimeout = setTimeout(() => {
                            console.log('[Connection] ping 超時未收到 pong，關閉連線');
                            this.closeWebSocket();
                            this.setServerOnline(false);
                            this.scheduleReconnect();
                        }, 5000);
                    }
                }, 15000);
            },
            
            scheduleReconnect() {
                if (this.reconnectTimeout) return; // 已經排程中
                
                // 如果瀏覽器報告離線，不排程重連
                if (!navigator.onLine) {
                    console.log('[Connection] 瀏覽器報告離線，暫不排程重連');
                    return;
                }
                
                // 固定 3 秒重試間隔
                const retryDelay = 3000;
                console.log(`[Connection] 將在 ${retryDelay / 1000} 秒後嘗試重新連線...`);
                
                this.reconnectTimeout = setTimeout(() => {
                    this.reconnectTimeout = null;
                    this.connectWebSocket();
                }, retryDelay);
            },
            
            // 設定伺服器連線狀態
            setServerOnline(online) {
                console.log('[Connection] setServerOnline:', online);
                this.serverOnline = online;
                this.updateConnectionState();
            },
            
            // 計算並更新總體連線狀態
            // 在線條件：瀏覽器在線 AND 伺服器連線成功
            // 離線條件：瀏覽器離線 OR 伺服器離線
            updateConnectionState() {
                const isOnline = this.browserOnline && this.serverOnline;
                console.log('[Connection] updateConnectionState - 瀏覽器:', this.browserOnline, '伺服器:', this.serverOnline, '=> 總體:', isOnline);
                
                const wasOffline = this.lastOnlineState === false;
                const wasOnline = this.lastOnlineState === true;
                
                if (this.lastOnlineState === isOnline) return; // 狀態沒變，不處理
                
                this.lastOnlineState = isOnline;
                this.updateUI(isOnline);
                
                // 發送事件通知其他模組（如 OfflineSearchManager）
                window.dispatchEvent(new CustomEvent('connectionStateChanged', {
                    detail: { isOnline }
                }));
                
                if (isOnline) {
                    console.log('[Connection] 已連線（瀏覽器+伺服器都在線）');
                    // 只有從離線恢復時才顯示通知
                    if (wasOffline) {
                        this.showNotification('已恢復連線', 'success');
                    }
                } else {
                    console.log('[Connection] 已離線（瀏覽器或伺服器離線）');
                    // 只有從線上變離線時才顯示通知
                    if (wasOnline) {
                        this.showNotification('連線已中斷，已切換至離線模式', 'warning');
                    }
                }
            },
            
            updateUI(isOnline) {
                console.log('[Connection] updateUI 被呼叫, isOnline:', isOnline);
                const indicator = document.getElementById('connectionIndicator');
                const banner = document.getElementById('offlineBanner');
                const submitBtn = document.querySelector('#foodForm button[type="submit"]');
                const deleteBtn = document.getElementById('deleteBtn');
                const favoriteBtn = document.getElementById('favoriteBtn');
                const formInputs = document.querySelectorAll('#foodForm input:not([type="hidden"]), #foodForm textarea, #foodForm select');
                
                console.log('[Connection] indicator 元素:', indicator);
                
                if (indicator) {
                    if (isOnline) {
                        indicator.className = 'connection-indicator online';
                        indicator.innerHTML = '<i class="bi bi-wifi"></i> 線上';
                    } else {
                        indicator.className = 'connection-indicator offline';
                        indicator.innerHTML = '<i class="bi bi-wifi-off"></i> 離線';
                    }
                    console.log('[Connection] indicator 已更新為:', isOnline ? '線上' : '離線');
                } else {
                    console.warn('[Connection] 找不到 connectionIndicator 元素！');
                }
                
                if (banner) {
                    if (isOnline) {
                        banner.style.display = 'none';
                        document.body.classList.remove('offline-mode');
                    } else {
                        banner.style.display = 'block';
                        document.body.classList.add('offline-mode');
                    }
                }
                
                // 控制表單和按鈕的啟用/禁用狀態
                if (submitBtn) {
                    submitBtn.disabled = !isOnline;
                    if (!isOnline) {
                        submitBtn.classList.add('btn-disabled');
                        submitBtn.title = '離線時無法儲存';
                    } else {
                        submitBtn.classList.remove('btn-disabled');
                        submitBtn.title = '';
                    }
                }
                
                if (deleteBtn) {
                    deleteBtn.disabled = !isOnline;
                    if (!isOnline) {
                        deleteBtn.classList.add('btn-disabled');
                        deleteBtn.title = '離線時無法刪除';
                    } else {
                        deleteBtn.classList.remove('btn-disabled');
                        deleteBtn.title = '';
                    }
                }
                
                if (favoriteBtn) {
                    favoriteBtn.disabled = !isOnline;
                    if (!isOnline) {
                        favoriteBtn.classList.add('btn-disabled');
                        favoriteBtn.title = '離線時無法變更收藏狀態';
                    } else {
                        favoriteBtn.classList.remove('btn-disabled');
                        favoriteBtn.title = '';
                    }
                }
                
                // 控制表單輸入欄位的啟用/禁用狀態
                formInputs.forEach(input => {
                    input.disabled = !isOnline;
                    if (!isOnline) {
                        input.classList.add('input-disabled');
                    } else {
                        input.classList.remove('input-disabled');
                    }
                });
            },
            
            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'success' ? 'success' : 'warning'}`;
                const topOffset = document.body.classList.contains('offline-mode') ? 68 : 20;
                notification.style.cssText = `
                    position: fixed;
                    top: ${topOffset}px;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 1100;
                    padding: 12px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: slideDown 0.3s ease;
                    min-width: 280px;
                    max-width: 90vw;
                    text-align: center;
                    white-space: nowrap;
                `;
                notification.innerHTML = `<i class="bi bi-${type === 'success' ? 'wifi' : 'wifi-off'}"></i> ${message}`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        };
        
        // 頁面載入時初始化連線狀態管理
        document.addEventListener('DOMContentLoaded', () => {
            ConnectionManager.init();
        });

    </script>

    <style>
        /* 離線橫幅 - 固定在頁面頂部 */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 500;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .offline-banner i {
            margin-right: 0.5rem;
        }
        
        /* 當離線橫幅顯示時，為 body 添加 padding-top */
        body.offline-mode {
            padding-top: 48px;
        }
        
        /* 連線狀態指示器 */
        .connection-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .connection-indicator.online {
            background: var(--success-100, #dcfce7);
            color: var(--success-700, #15803d);
        }
        
        .connection-indicator.offline {
            background: var(--warning-100, #fef3c7);
            color: var(--warning-700, #a16207);
        }
        
        /* 通知動畫 */
        @keyframes slideDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes slideUp {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        /* 頁面標題左側區塊 */
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        /* 離線時禁用按鈕樣式 */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        
        /* 離線時禁用輸入框樣式 */
        .input-disabled {
            opacity: 0.6;
            background-color: #f3f4f6 !important;
            cursor: not-allowed !important;
        }
        
        /* 食物名稱和單位容器 */
        .name-unit-container {
            display: flex;
            gap: var(--space-3);
            align-items: end;
        }
        
        .name-input-wrapper {
            flex: 1;
        }
        
        .food-name-input {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: #000000;
        }
        
        .quantity-unit-group {
            display: flex;
            gap: var(--space-2);
            align-items: end;
            min-width: 200px;
        }
        
        .quantity-input {
            width: 80px;
        }
        
        .quantity-number {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: #000000;
            text-align: center;
            border: 2px solid var(--primary-400);
        }
        
        .quantity-number:focus {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }
        
        .unit-selector {
            width: 100px;
        }
        
        .unit-select {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: #000000;
            border: 2px solid var(--primary-500);
        }
        
        /* 碳水化合物輸入框樣式 */
        .carb-input {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: #000000;
        }
        
        /* 圖片上傳區域 */
        .image-upload-area {
            border: 2px dashed var(--secondary-300);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            background: var(--secondary-50);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-upload-area:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }
        
        .image-upload-area.dragover {
            border-color: var(--primary-500);
            background: var(--primary-50);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--secondary-400);
            margin-bottom: var(--space-4);
        }
        
        .upload-text {
            color: var(--secondary-600);
            margin-bottom: var(--space-2);
            font-weight: 500;
        }
        
        .upload-hint {
            font-size: var(--font-size-sm);
            color: var(--secondary-500);
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            display: block;
        }
        
        .image-preview-container {
            position: relative;
            display: inline-block;
        }
        
        .image-remove-btn {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }
        
        .image-remove-btn:hover {
            background: var(--danger-600);
            transform: scale(1.1);
        }
        
        .progress-bar {
            height: 4px;
            background: var(--secondary-200);
            border-radius: 2px;
            overflow: hidden;
            margin-top: var(--space-4);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* 輸入框圖標 */
        .input-with-icon {
            position: relative;
        }
        
        .input-icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-400);
            z-index: 10;
        }
        
        .input-with-icon-padding {
            padding-left: var(--space-12);
        }
        
        /* 計算器樣式 */
        .calculator-section {
            padding: var(--space-4);
            border: 1px solid var(--secondary-300);
            border-radius: var(--radius-lg);
            background: var(--white);
            box-shadow: var(--shadow-sm);
            margin-top: var(--space-4);
        }
        
        .calculator-actions {
            margin-top: var(--space-4);
            display: flex;
            gap: var(--space-3);
        }
        
        .result-field {
            background: #f9f9f9;
            cursor: not-allowed;
        }
        
        /* 驗證錯誤樣式 */
        .input-error {
            border-color: var(--danger-500) !important;
            background-color: #fef2f2 !important;
            animation: shake 0.4s ease;
        }
        
        .input-error:focus {
            border-color: var(--danger-600) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }
        
        /* 固定在頂部的錯誤提示 */
        .fixed-top-alert {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            margin: 0;
            border-radius: 0;
            padding: 1rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideDownFromTop 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .fixed-top-alert .alert-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
        }
        
        .fixed-top-alert i.bi-exclamation-triangle {
            font-size: 1.2rem;
        }
        
        .alert-close-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            margin-left: 1rem;
            opacity: 0.7;
            transition: opacity 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .alert-close-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .alert-close-btn:active {
            transform: scale(0.95);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @keyframes slideDownFromTop {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .validation-error-alert {
            margin-top: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        /* 響應式調整 */
        @media (max-width: 1023px) {
            .grid.lg\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                flex-direction: column;
                gap: var(--space-4);
                text-align: center;
            }
            
            .flex.justify-end {
                justify-content: center;
                flex-direction: column;
            }
        }
        
        @media (max-width: 767px) {
            .grid.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .name-unit-container {
                flex-direction: column;
                gap: var(--space-3);
            }
            
            .quantity-unit-group {
                min-width: auto;
                justify-content: center;
            }
            
            .quantity-input {
                width: 100px;
            }
            
            .unit-selector {
                width: 120px;
            }
            
            .image-upload-area {
                padding: var(--space-6);
                min-height: 150px;
            }
            
            .upload-icon {
                font-size: 2rem;
            }
        }
        
        /* 美化最愛按鈕樣式 */
        .favorite-btn {
            position: relative;
            background: #ffffff;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 18px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }
        
        .favorite-btn:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }
        
        .favorite-btn-content {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .favorite-icon {
            font-size: 1.1rem;
            transition: color 0.2s ease;
        }
        
        .favorite-text {
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }
        
        /* 未收藏狀態 */
        .favorite-btn-inactive {
            color: #64748b;
        }
        
        .favorite-btn-inactive:hover {
            color: #374151;
            border-color: #9ca3af;
        }
        
        .favorite-btn-inactive:hover .favorite-icon {
            color: #f59e0b;
        }
        
        /* 已收藏狀態 */
        .favorite-btn-active {
            background: #fefbf3;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .favorite-btn-active .favorite-icon {
            color: #f59e0b;
        }
        
        .favorite-btn-active:hover {
            background: #fef7ed;
            border-color: #d97706;
        }
        
        .favorite-btn-active:hover .favorite-icon {
            color: #d97706;
        }
        
        /* 點擊效果 */
        .favorite-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* 響應式調整 */
        @media (max-width: 767px) {
            .favorite-btn {
                padding: 8px 14px;
            }
            
            .favorite-icon {
                font-size: 1rem;
            }
            
            .favorite-text {
                font-size: 0.85rem;
            }
        }
        
        /* 工具類 */
        .font-semibold { font-weight: 600; }
        .text-danger-500 { color: var(--danger-500); }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
    </style>
</body>
</html>
